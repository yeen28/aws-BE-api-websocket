# 1. 종속성 해결 및 캐싱을 위한 스테이지
FROM gradle:8.4-jdk17-alpine AS deps
WORKDIR /app

# Gradle 기본 설정 복사
COPY build.gradle settings.gradle gradlew ./
COPY gradle/ ./gradle

# 모듈별 build.gradle 복사
COPY chat-core/build.gradle ./chat-core/
COPY chat-api/build.gradle ./chat-api/
COPY chat-websocket/build.gradle ./chat-websocket/

# 종속성만 다운로드 (캐시 목적)
RUN ./gradlew :chat-api:dependencies --no-daemon

# 2. 전체 소스 복사 및 빌드
FROM gradle:8.4-jdk17-alpine AS build
WORKDIR /app

# deps 스테이지 복사
COPY --from=deps /app ./

# 전체 소스 복사 (멀티모듈 정상 동작 위해 반드시 필요)
COPY . .

# chat-api 모듈 빌드 (테스트 제외)
RUN ./gradlew :chat-api:build -x test --no-daemon

# 3. 최종 실행 이미지
FROM eclipse-temurin:17-jdk-alpine
WORKDIR /app

COPY --from=build /app/chat-api/build/libs/*-SNAPSHOT.jar app.jar
EXPOSE 9000

# 헬스체크 (ALB 연결 시 사용되는 예시 DNS는 빌드시 생략)
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s \
  CMD wget --spider -q http://localhost:9000/actuator/health || exit 1

ENTRYPOINT ["sh", "-c", "exec java -jar app.jar"]
